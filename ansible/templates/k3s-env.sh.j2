#!/bin/bash
# K3s environment setup
# Generated by Ansible

# Set kubeconfig
export KUBECONFIG=~/.kube/config

# Set kubectl aliases
alias k='kubectl'
alias kg='kubectl get'
alias kgpo='kubectl get pods'
alias kgn='kubectl get nodes'
alias kdesc='kubectl describe'
alias kl='kubectl logs'
alias kex='kubectl exec -it'

# Set some useful functions
kpods() {
  kubectl get pods -A | grep -v "Running\|Completed"
}

kdebug() {
  kubectl run debug-pod --rm -i --tty --image=ubuntu -- bash
}

kversion() {
  kubectl version --short
}

# Display cluster info
kcluster() {
  echo -e "\033[0;32mCluster Nodes:\033[0m"
  kubectl get nodes -o wide
  
  echo -e "\n\033[0;32mPods not in Running state:\033[0m"
  kpods
  
  echo -e "\n\033[0;32mCluster Info:\033[0m"
  kubectl cluster-info
}

# Fix common issues
kfix_taints() {
  echo -e "\033[0;33mRemoving Cilium taints from all nodes...\033[0m"
  ~/scripts/fix_node_taints.sh
}

kfix_coredns() {
  echo -e "\033[0;33mFixing CoreDNS issues...\033[0m"
  ~/scripts/fix_coredns.sh
}

kfix_all() {
  echo -e "\033[0;33mApplying all fixes to the cluster...\033[0m"
  kfix_taints
  kfix_coredns
}

# Print welcome message
echo -e "\033[0;33m==== K3s Pi Cluster Environment ====\033[0m"
echo -e "K3s API Server: https://{{ k3s_api_vip }}:6443"
echo -e "\nUse the following commands to manage your cluster:"
echo -e " - \033[0;32mkcluster\033[0m: Show cluster overview"
echo -e " - \033[0;32mkpods\033[0m: Show problematic pods"
echo -e " - \033[0;32mkdebug\033[0m: Start a debug pod"
echo -e " - \033[0;32mkversion\033[0m: Show kubernetes version"
echo -e " - \033[0;32mkfix_taints\033[0m: Fix node taints"
echo -e " - \033[0;32mkfix_coredns\033[0m: Fix CoreDNS issues"
echo -e " - \033[0;32mkfix_all\033[0m: Apply all fixes"
echo -e " - \033[0;32mk\033[0m: Shorthand for kubectl"
